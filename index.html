<script>
    const App = function() {
        let shortcuts = [], config = { blur: 24, opacity: 40 }, editingId = null;
        
        const els = {
            grid: document.getElementById('shortcut-grid'),
            wallpaper: document.getElementById('wallpaper'),
            overlay: document.getElementById('overlay'),
            input: document.getElementById('search-input'),
            loader: document.getElementById('app-loader'),
            container: document.getElementById('main-container'),
            ctxMenu: document.getElementById('ctx-menu')
        };

        const init = async () => {
            loadData();
            // 优先尝试加载缓存壁纸，返回 boolean 标识是否命中缓存
            const hitCache = await loadWallpaper(); 
            
            renderGrid();
            setupTime();
            setupListeners();
            applyStyles();
            
            lucide.createIcons();

            // 如果命中缓存，立即移除 Loader，消除等待感
            // 如果未命中（正在请求API），保留原有的过渡动画
            const delay = hitCache ? 0 : 300;
            
            setTimeout(() => { 
                els.loader.style.opacity = '0'; 
                setTimeout(() => els.loader.remove(), hitCache ? 0 : 500); 
                els.container.style.opacity = '1'; 
                els.container.style.transform = 'translateY(0)'; 
                
                // 聚焦输入框
                els.input.focus();
            }, delay);
        };

        const loadData = () => {
            const s = localStorage.getItem('v2_shortcuts');
            const c = localStorage.getItem('v2_config');
            shortcuts = s ? JSON.parse(s) : USER_CONFIG.defaultShortcuts;
            config = c ? JSON.parse(c) : config;
        };

        const saveData = () => {
            localStorage.setItem('v2_shortcuts', JSON.stringify(shortcuts));
            localStorage.setItem('v2_config', JSON.stringify(config));
            renderGrid();
            applyStyles();
        };

        // 重构的核心：带缓存机制的壁纸加载
        const loadWallpaper = async (forceRefresh = false) => {
            const STORAGE_KEY = 'v2_wallpaper_cache';
            const todayStr = new Date().toDateString(); // 例如 "Mon Jan 12 2026"
            
            // 1. 尝试读取缓存
            let cache = null;
            try {
                cache = JSON.parse(localStorage.getItem(STORAGE_KEY));
            } catch(e) {}

            // 2. 缓存命中逻辑：非强制刷新 && 缓存存在 && 缓存日期是今天
            if (!forceRefresh && cache && cache.date === todayStr && cache.url) {
                // 直接使用缓存，无需网络请求
                els.wallpaper.style.backgroundImage = `url(${cache.url})`;
                console.log('Wallpaper: Cache Hit');
                return true; // 返回 true 表示命中缓存
            }

            // 3. 缓存失效或强制刷新，发起网络请求
            console.log('Wallpaper: Network Request');
            try {
                const ts = forceRefresh ? `&t=${Date.now()}` : '';
                const res = await fetch(`https://bing.biturl.top/?resolution=3840&format=json&index=0&mkt=zh-CN${ts}`);
                const data = await res.json();
                
                // 图片预加载，防止只有 URL 但图片未下载时的闪烁
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = data.url;
                    img.onload = () => {
                        els.wallpaper.style.backgroundImage = `url(${data.url})`;
                        // 写入缓存
                        localStorage.setItem(STORAGE_KEY, JSON.stringify({
                            url: data.url,
                            date: todayStr
                        }));
                        resolve(false); // 返回 false 表示未命中（走了网络）
                    };
                    img.onerror = () => {
                        useFallback();
                        resolve(false);
                    };
                });
            } catch (e) {
                useFallback();
                return false;
            }
        };

        const useFallback = () => {
            els.wallpaper.style.backgroundImage = `url(${USER_CONFIG.fallbackWallpaper})`;
        };

        // --- 以下逻辑保持不变 ---
        const renderGrid = () => {
            els.grid.innerHTML = '';
            shortcuts.forEach(item => {
                const card = document.createElement('div');
                card.className = 'glass-panel rounded-2xl p-4 flex flex-col items-center justify-center min-h-[120px] relative group hover-scale transition-all cursor-pointer border-transparent hover:border-white/20';
                const iconUrl = `https://www.google.com/s2/favicons?domain=${new URL(item.url).hostname}&sz=128`;
                
                card.innerHTML = `
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 z-20">
                        <button class="p-1.5 bg-black/60 rounded-md hover:bg-blue-500/80 text-white backdrop-blur-sm transition-colors" onclick="event.stopPropagation(); app.openEditModal('${item.id}')"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        <button class="p-1.5 bg-black/60 rounded-md hover:bg-red-500/80 text-white backdrop-blur-sm transition-colors" onclick="event.stopPropagation(); app.deleteShortcut('${item.id}')"><i data-lucide="trash" class="w-3 h-3"></i></button>
                    </div>
                    <img src="${iconUrl}" class="w-10 h-10 mb-4 rounded-xl shadow-lg group-hover:scale-110 transition-transform duration-300" onerror="this.src='https://ui-avatars.com/api/?name=${item.title}&background=random&color=fff'">
                    <span class="text-xs font-medium text-white/80 truncate w-full text-center tracking-wide group-hover:text-white transition-colors">${item.title}</span>
                `;
                card.onclick = () => window.location.href = item.url;
                els.grid.appendChild(card);
            });
            lucide.createIcons();
        };

        const setupListeners = () => {
            els.input.addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch('standard'); });
            
            const blurRange = document.getElementById('blur-range');
            const opacityRange = document.getElementById('opacity-range');

            blurRange.addEventListener('input', (e) => { 
                config.blur = e.target.value; 
                applyStyles(); 
                localStorage.setItem('v2_config', JSON.stringify(config)); 
            });

            opacityRange.addEventListener('input', (e) => { 
                config.opacity = e.target.value; 
                applyStyles(); 
                localStorage.setItem('v2_config', JSON.stringify(config)); 
            });

            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const { clientX: x, clientY: y } = e;
                const menuWidth = 192; 
                const menuHeight = 150;
                
                let finalX = x;
                let finalY = y;
                
                if (x + menuWidth > window.innerWidth) finalX = window.innerWidth - menuWidth - 10;
                if (y + menuHeight > window.innerHeight) finalY = window.innerHeight - menuHeight - 10;

                els.ctxMenu.style.left = `${finalX}px`;
                els.ctxMenu.style.top = `${finalY}px`;
                els.ctxMenu.classList.remove('hidden');
            });
            
            document.addEventListener('click', () => els.ctxMenu.classList.add('hidden'));
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape') els.ctxMenu.classList.add('hidden'); });
        };

        const doSearch = (type) => {
            const q = els.input.value.trim(), eq = encodeURIComponent(q);
            if (type === 'gemini') window.location.href = q ? `https://gemini.google.com/app?q=${eq}` : `https://gemini.google.com/app`;
            else if (type === 'ai') window.location.href = q ? `https://www.google.com/search?q=${eq}&newwindow=1&udm=14` : `https://www.google.com`; 
            else window.location.href = q ? `https://www.google.com/search?q=${eq}` : `https://www.google.com`;
        };

        const applyStyles = () => {
            document.documentElement.style.setProperty('--glass-blur', `${config.blur}px`);
            els.overlay.style.backgroundColor = `rgba(0,0,0,${config.opacity / 100})`;
            document.getElementById('blur-range').value = config.blur;
            document.getElementById('opacity-range').value = config.opacity;
            document.getElementById('blur-val').innerText = config.blur + 'px';
            document.getElementById('opacity-val').innerText = config.opacity + '%';
        };

        const setupTime = () => {
            const update = () => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                document.getElementById('clock-date').innerText = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });
            };
            update(); setInterval(update, 1000);
        };

        const openEditModal = (id = null) => {
            editingId = id;
            const item = id ? shortcuts.find(s => s.id === id) : null;
            document.getElementById('edit-title').value = item ? item.title : '';
            document.getElementById('edit-url').value = item ? item.url : '';
            document.getElementById('modal-title').innerText = item ? 'Edit Shortcut' : 'Add New Shortcut';
            document.getElementById('edit-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('edit-title').focus(), 100);
        };

        return {
            init, doSearch, loadWallpaper,
            toggleSettings: () => { 
                const modal = document.getElementById('settings-modal');
                modal.classList.toggle('hidden'); 
                if(!modal.classList.contains('hidden')) applyStyles(); 
            },
            openEditModal, 
            closeEditModal: () => { document.getElementById('edit-modal').classList.add('hidden'); editingId = null; },
            saveShortcut: () => {
                const title = document.getElementById('edit-title').value.trim();
                let url = document.getElementById('edit-url').value.trim();
                if (!title || !url) return;
                if (!url.startsWith('http')) url = 'https://' + url;
                
                if (editingId) {
                    const idx = shortcuts.findIndex(s => s.id === editingId);
                    if(idx !== -1) shortcuts[idx] = { ...shortcuts[idx], title, url };
                } else {
                    shortcuts.push({ id: Date.now().toString(), title, url });
                }
                saveData(); document.getElementById('edit-modal').classList.add('hidden');
            },
            deleteShortcut: (id) => { 
                if(confirm('Are you sure you want to delete this shortcut?')) { 
                    shortcuts = shortcuts.filter(s => s.id !== id); 
                    saveData(); 
                } 
            },
            triggerLens: () => document.getElementById('lens-input').click(),
            resetData: () => { if(confirm('Factory Reset: This will clear all your shortcuts and settings. Continue?')) { localStorage.clear(); location.reload(); } },
            exportData: () => { 
                const dataStr = JSON.stringify({ shortcuts, config }, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                a.download = `workspace-backup-${new Date().toISOString().slice(0,10)}.json`; 
                a.click(); 
            },
            importData: () => document.getElementById('import-file').click(),
            handleImport: (input) => { 
                const r = new FileReader(); 
                r.onload = (e) => { 
                    try { 
                        const d = JSON.parse(e.target.result); 
                        if(d.shortcuts) localStorage.setItem('v2_shortcuts', JSON.stringify(d.shortcuts)); 
                        if(d.config) localStorage.setItem('v2_config', JSON.stringify(d.config)); 
                        location.reload(); 
                    } catch (err) { alert('Invalid backup file'); } 
                }; 
                if(input.files[0]) r.readAsText(input.files[0]); 
            }
        };
    }();
    window.app = App; window.onload = App.init;
</script>
